<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    textarea {
      width: 100%;
      height: 150px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <h2>Enviar Certificados por Rango de Filas</h2>
  <form id="sendRangeForm" onsubmit="return false;">
    <label for="sheetUrl">URL de la hoja de c√°lculo:</label><br>
    <input type="text" id="sheetUrl" name="sheetUrl" required><br><br>

    <label for="folderUrl">URL de la carpeta con los certificados:</label><br>
    <input type="text" id="folderUrl" name="folderUrl" required><br><br>

    <label for="mensajeEmail">Texto adicional al correo electr√≥nico:</label><br>
    <textarea id="mensajeEmail" name="mensajeEmail" placeholder="Ingrese la informaci√≥n adicional que debe ser agregada al correo electr√≥nico..."></textarea><br><br>

    <label for="startRow">Fila inicial (m√≠nimo 1):</label><br>
    <input type="number" id="startRow" name="startRow" min="1" required><br><br>

    <label for="endRow">Fila final (m√°x. 30 filas por ejecuci√≥n):</label><br>
    <input type="number" id="endRow" name="endRow" min="1" required><br><br>

    <input type="button" id="sendBtn" value="Enviar Certificados" onclick="iniciarEnvioPorRango()">
    <input type="button" id="stopBtn" value="Detener" onclick="detenerEnvio()" disabled>
  </form>

  <!-- Modal de Logs -->
  <div id="logModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); width:80%; max-height:70%; overflow:auto; background:white; border:2px solid #444; padding:15px; z-index:9999; box-shadow: 0px 4px 8px rgba(0,0,0,0.3); border-radius: 10px;">
    <h3>üìù Registro de Ejecuci√≥n</h3>
    <pre id="logContenido" style="white-space: pre-wrap;"></pre>
    <button onclick="cerrarLogModal()">Cerrar</button>
  </div>

  <script>
    function iniciarEnvioPorRango() {
      const sheetUrl = document.getElementById('sheetUrl').value.trim();
      const folderUrl = document.getElementById('folderUrl').value.trim();
      const mensajeEmail = document.getElementById('mensajeEmail').value.trim();
      const startRow = parseInt(document.getElementById('startRow').value.trim(), 10);
      const endRow = parseInt(document.getElementById('endRow').value.trim(), 10);

      if (!sheetUrl || !folderUrl || isNaN(startRow) || isNaN(endRow)) {
        alert("Por favor, completa todos los campos obligatorios.");
        logMensaje("‚ùå Campos requeridos incompletos. Operaci√≥n cancelada.");
        return;
      }

      if (startRow < 1 || endRow < 1 || endRow < startRow) {
        alert("El rango ingresado no es v√°lido.");
        logMensaje("‚ùå Rango inv√°lido: inicio=" + startRow + ", fin=" + endRow);
        return;
      }

      const cantidad = endRow - startRow + 1;
      if (cantidad < 5 || cantidad > 30) {
        alert("Solo puedes enviar entre 5 y 30 certificados por ejecuci√≥n.");
        logMensaje("‚ùå Se solicit√≥ enviar " + cantidad + " certificados. L√≠mite: 5‚Äì30.");
        return;
      }

      bloquearFormulario(true);
      logMensaje("üì• Iniciando env√≠o de certificados por rango...");
      logMensaje(`üîó Hoja de c√°lculo: ${sheetUrl}`);
      logMensaje(`üìÅ Carpeta de certificados: ${folderUrl}`);
      logMensaje(`üìå Rango de filas: ${startRow} a ${endRow}`);

      google.script.run
        .withSuccessHandler(() => {
          logMensaje("‚úÖ Certificados enviados satisfactoriamente.");
          bloquearFormulario(false);
        })
        .withFailureHandler((error) => {
          alert("Error en el env√≠o: " + error.message);
          logMensaje("‚ùå Error en el env√≠o: " + error.message);
          bloquearFormulario(false);
        })
        .procesarYEnviarCertificadosPorRango(startRow, endRow, sheetUrl, folderUrl, mensajeEmail);
    }

    function detenerEnvio() {
      google.script.run
        .withSuccessHandler(() => {
          alert("Proceso detenido.");
          bloquearFormulario(false);
          logMensaje("‚õî Proceso detenido por el usuario.");
        })
        .detenerEnvioCertificados();
    }

    function bloquearFormulario(bloquear) {
      document.getElementById('sheetUrl').disabled = bloquear;
      document.getElementById('folderUrl').disabled = bloquear;
      document.getElementById('mensajeEmail').disabled = bloquear;
      document.getElementById('startRow').disabled = bloquear;
      document.getElementById('endRow').disabled = bloquear;
      document.getElementById('sendBtn').disabled = bloquear;
      document.getElementById('stopBtn').disabled = !bloquear;
    }

    function logMensaje(msg) {
      const logModal = document.getElementById("logModal");
      const logContenido = document.getElementById("logContenido");
      logModal.style.display = "block";
      const hora = new Date().toLocaleTimeString();
      logContenido.textContent += `[${hora}] ${msg}\n`;
    }

    function cerrarLogModal() {
      document.getElementById("logModal").style.display = "none";
    }
  </script>
</body>
</html>
